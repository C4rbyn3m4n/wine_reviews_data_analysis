---
title: "Exploring and Analyizing Wine Enthusiast Reviews"
output: 
  html_notebook:
    toc: true
    toc_float: true
    theme: united
---

# Prerequisites

Loading the required packages
```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(dplyr)
library(ggplot2)
library(ggcute)
```

# Dataset

Import processed data, which can be found [here](https://github.com/C4rbyn3m4n/wine_reviews_data_analysis/blob/master/data/processed_data/preprocessing.rmd).

```{r}
#read preprocessed data
wines <- read.csv(file = '../data/processed_data/wines.csv')
```

Get sample of dataset
```{r}
#set seed value to birthday of Ricardo Rodriguez, American wrestler and ring announcer and Dr. Reinaldo (Rei) Sanchez-Arias
set.seed(19630217)

#set percentage to test with for simplicity, if needed
percentage <- 5
wine_sample<- sample_n(wines, percentage/100*nrow(wines))
```

### Split Taster data into different Data Frame

```{r}
tasters <- wines %>%
  select(taster_name, taster_twitter_handle) %>% unique()
tasters
```

Drop `taster_twitter_handle` in wines dataframe

```{r}
wines <- wines %>%
  select(-taster_twitter_handle)
head(wines)
```
## Add Reviewer profile info

Each reviewer has there own bias. To offset that we made a "profile" for each reviewer which includes characteristics like: `avg_points`, `sd_points`, and `var_points`
```{r}
taster_rating_profile <- wines %>%
  group_by(taster_name) %>%
  summarize(
    avg_points = mean(points),
    sd_points = sd(points),
    var_points = var(points),
    reviews = n()
  )

tasters <- inner_join(tasters, taster_rating_profile, by = "taster_name")
head(tasters)
```

### Add Rating Classification

Add following classification to wine dataset as found on the [website](https://www.winemag.com/2010/04/09/you-asked-how-is-a-wines-score-determined/):

|Category  | Rating  | Description                                            |
|----------|---------|--------------------------------------------------------|
|Classic   |	98-100 | The pinnacle of quality.                               |
|Superb    |	94-97	 | A great achievement.                                   |
|Excellent |	90-93	 | Highly recommended.                                    |
|Very Good |  87-89	 | Often good value; well recommended.                    |
|Good	     |  83-86	 | Suitable for everyday consumption; often good value.   |
|Acceptable|	80-82	 | Can be employed in casual, less-critical circumstances |

```{r}
# function to add rating
rating_category <- function(points){
  if(points>=98){
    return("Classic")
  }
  else if (points>=94){
    return("Superb")
  }
  else if(points>=90){
    return("Excellent")
  }
  else if(points>=87){
    return("Very Good")
  }
  else if(points>=83){
    return("Good")
  }
  else{
    return("Acceptable")
  }
}

wines<- wines %>%
  rowwise() %>%
  mutate(rating_category = rating_category(points))
head(wines)
```

## Add Adjusted Points

Since, each reviewer has a different bias we created a normalized metric, `norm_points`, by looking at the number of standard deviatioins a wine is from the reviewer's `avg_points`. This gives use a more accurate representation of which which wines are better than the rest.

```{r}
normalize_points <- function(data){
  left_join(data, tasters, by = "taster_name")%>%
    rowwise() %>%
    mutate(norm_points = (points-avg_points)/sd_points) %>%
    select(-avg_points, -sd_points, -var_points, -taster_twitter_handle, -reviews)
}

wines <- normalize_points(wines)
head(wines) 
```

## Data Sanitation
Vintage seems to have year 7200, so we filtered all data upto 2019
``` {r}
wines <- wines %>%
  filter(vintage<2019)
```
# Data Exploration

## Univariate Exploration
### Alcohol Amount
TODO: EXPLAIN GRAPH AND WHAT WE ARE DOING HERE (OSAKI)
```{r}
wines %>% 
  group_by(alcohol) %>% 
  ggplot(mapping = aes(x = alcohol)) +
  geom_histogram(na.rm = T,
                 bins = 50) +
  scale_x_continuous(
    name = "Alchohol Percentage", 
    breaks = seq(0,25,1), 
    limits = c(4,22)) +
  scale_fill_fairyfloss() +
  theme_fairyfloss() +
  theme(plot.background = element_rect("white"))
```

### Vintage
Understanding what vintage the reivewed wines were from.
```{r}
wines %>%
  group_by(vintage) %>%
  summarise(count = n())
```


TODO: EXPLAIN GRPAHS (IZZY)
(Note: Data points before 1990 have been omitted for clarity in visualization)
```{r}
wines %>%
  group_by(vintage) %>%
  ggplot() +
  geom_bar(mapping = aes(x=vintage),
           na.rm = T) +
  scale_x_continuous(breaks = seq(1990,2019,5), 
                     limits = c(1990,2019)) +
  labs(x = "Vintage", y = "Count") +
  theme_fairyfloss()
```

### Winery
To better understand the number wines per winery, we did a univarite visualization that counts the number of wines per winery showing only 15 winerys to give you an idea what winery has the most selction of wines.
```{r}
wines %>%
  group_by(winery) %>%
  summarize(count = n()) %>%
  arrange(desc(count)) %>%
  slice(1:15) %>%
  ggplot() +
  geom_col(mapping = aes(x=count, y = reorder(winery, count)))
```

### Province
To better understand the number wines per province, we did a univarite visualization that counts the number of wines per province showing only the top 10 provinces with the most wines. This can give the reader an idea where their wine will most likely be made with California standing out as a clear leader.
```{r}
wines %>% 
  group_by(province) %>% 
  summarize(count = n()) %>% 
  arrange(desc(count)) %>% 
  slice(1:10) %>% 
  ggplot()+
  geom_col(aes(x = count, y = reorder(province, count)))
```

### Price
Calculating the Mean, Standard Deviation, Minimum, and Max Price for the entire wine dataset and printing the values.
```{r}
mean_price <- mean(wines$price, na.rm = TRUE)
sd_price <- sd(wines$price, na.rm = TRUE)
min_price <- min(wines$price, na.rm = TRUE)
max_price <- max(wines$price, na.rm = TRUE)

print(paste("Mean Price:", mean_price))
print(paste("SD Price:", sd_price))
print(paste("Min Price:", min_price))
print(paste("Max Price:", max_price))
```

TODO: Vamsi
```{r}
wines %>% 
  filter(price < 1000) %>% 
  group_by(price) %>% 
  summarise(count = n()) %>% 
  ggplot() +
  geom_histogram(
    mapping = aes(x=price), 
    na.rm = T) 
```

###  Points 
Calculating the Mean, Standard Deviation, Minimum, and Max Points for the entire wine dataset and printing the values.
```{r}
mean_points <- mean(wines$points, na.rm = TRUE)
sd_points <- sd(wines$points, na.rm = TRUE)
min_points <- min(wines$points, na.rm = TRUE)
max_points <- max(wines$points, na.rm = TRUE)

print(paste("Mean Points:", mean_points))
print(paste("SD Points:", sd_points))
print(paste("Min Points:", min_points))
print(paste("Max Points:", max_points))
```
TODO: EXPLAIN GRPAH OSAKI
```{r}
wines %>%
  ggplot() +
  geom_histogram(
    mapping = aes(x=points),
    bins = 20)
```

## Multivariate Exploration

## Taster by Points
To help you understand the point distribution by reviewers, we did a multivarite visualization that coorelates some taster names based on the average wine points as identified  by the x-intercept. This give you the reader an idea of how some reviewers correlate to the overall average.
```{r}
wines %>%
  ggplot() +
  geom_boxplot(aes(y=taster_name, x=points)) +
  geom_vline(xintercept = mean(wines$points))
```


## Price by Points
TODO EXPLAIN VAMSI
Notice the data is "stacked" and the socres range from 80-100
```{r}
wines %>% 
  ggplot() +
  geom_point(mapping = (aes(x = points, y = price)), na.rm = T, alpha = 0.15) +
  labs(title = "Price by Points", x = "Points", y = "Price")
```

TODO EXPLAIN VAMSI
```{r}
wines %>% 
  ggplot() +
  geom_point(mapping = (aes(x = points, y = log(price))), na.rm = T, alpha = 0.15) +
  labs(title = "log(Price) by Points", x = "Points", y = "log(Price)")
```

### Category
TODO EXPLAIN IZZY
This 
```{r}
wines %>% 
  group_by(points) %>% 
  filter(price < 1000) %>% 
  ggplot() +
  geom_point(mapping = aes(x=points, y = price, color = category), 
             na.rm = T) +
  facet_wrap(~ category) +
  scale_color_fairyfloss() +
  theme_minimal() +
  theme(legend.position = "none")
```



# Data Analysis

## Which province has the best wine?
TODO EXPLAIN OSAKI
To determine the best province for wine by points we average all the wines per province and return the top 10 with standard error.
```{r}
wines %>% 
  group_by(province) %>%
  summarise(avg_points_prov = mean(points), count = n(), std_points_prov_err = sd(points)/sqrt(count)) %>%
  filter(count>30) %>%
  arrange(desc(avg_points_prov)) %>%
  slice(1:10) %>%
  ggplot() +
  geom_col(mapping = aes(y=province, x= avg_points_prov)) +
   geom_errorbar(
    mapping = aes(
      y = province,
      x = avg_points_prov,
      xmin = avg_points_prov - std_points_prov_err, 
      xmax = avg_points_prov + std_points_prov_err
      ),
    width = 0.2
  )
```

## Which wine variety is the best?
To determine the best variety of wine we use the average point of all wines per variety with a sample size greater than 30. The graph below shows the the top 10 varieties with their respective standard error.

```{r}
wines %>% 
  group_by(variety) %>% 
  summarise(
    avg_points_variety = mean(points),
    count = n(),
    sd_err_points_variety = sd(points)/sqrt(count)) %>%
  filter(count>30) %>%
  arrange(desc(avg_points_variety)) %>%
  slice(1:10) %>%
  ggplot() +
  geom_col(mapping = aes(y=variety, x=avg_points_variety))+
  geom_errorbar(
    mapping = aes(
      y = variety,
      x = avg_points_variety,
      xmin = avg_points_variety - sd_err_points_variety, 
      xmax = avg_points_variety + sd_err_points_variety
      ),
    width = 0.2
  )
```

## How much are people willing to pay?
TODO IZZY
```{r}
user_price <- readline(prompt = "How much are you willing to spend on a bottle?")
user_price <- as.integer(user_price)

wines %>% 
  filter(price <= user_price) %>% 
  arrange(desc(points)) %>% 
  select(title, price, points)
```

## What is the best wine?
A easy way to determine the best wine is by simply finding the top 10 wines.
```{r}
wines %>%
  arrange(desc(points)) %>%
  slice(1:10)
```

However, this does not account for the graders bias. Instead, our group "normalized" the points based on each taster based on the number of standard deviations an wines is from the raters average. For example, Taster A could give a wine 100 but has an avgerage rating score of 95 with a standard deviation of 5. Whereas, Taster B could give a wine 91 and have an average score of 87 with a standard deviation of 2. Although, the wine tasted by Taster A got a perfect 100 score, Taster B's wine was much "better" wine since it was 2 standard deviations from the tasters avgerage compared to 1 standard deviation of the other wine.

Looking at the `norm_points` these are the top 10 best wines
```{r}
wines %>%
  arrange(desc(norm_points)) %>%
  slice(1:10)
```
## What is the best value wine?
A simple value metric we can use to determine best value is `points/price`
```{r}
wines %>%
  arrange(desc(points/price)) %>%
  slice(1:10)
```

However, again this metric is not normalized. Instead, `norm_points/price` would yield more robust results.
```{r}
wines %>%
  arrange(desc(norm_points/price)) %>%
  slice(1:10)
```

## Where are wines produced the most?


# Conclusion

# Future Works

# Works Cited
